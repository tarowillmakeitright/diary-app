<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diary</title>

  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Font + fallback -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Bitcount+Prop+Single:wght@100..900&display=swap" rel="stylesheet" />

  <style>
    :root {
      --main-width: 95%;
      --max-width: 600px;
    }

    body {
      /* ★ フォールバックを足してレンダ失敗時も読みやすく */
      font-family: "Bitcount Prop Single", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: black;
      color: white;
      transition: background-color 0.3s, color 0.3s;
      margin: 0;
      padding: 20px;
    }

    body.dark {
      background-color: #121212;
      color: #e0e0e0;
    }

    .container {
      max-width: var(--max-width);
      width: var(--main-width);
      margin: 0 auto;
    }

    h1 { font-size: 1.8em; text-align: center; }
    h2 { font-size: 1.8em; text-align: center; }

    label { display: block; margin-top: 15px; }

    textarea, input, select {
      background-color: inherit;
      color: inherit;
      border: 1px solid #ccc;
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
      font-size: 1em;
    }

    /* ★ エラースタイル：赤枠が一般的。緑が好みならこのままでOK */
    input.error, select.error, textarea.error { border: 2px solid #e53935; }

    section { margin-bottom: 30px; }

    button {
      background-color: #333;
      color: white;
      border: 1px solid white;
      padding: 8px 12px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background-color: #555; }

    ul { list-style: none; padding-left: 0; }

    dialog {
      border: none;
      border-radius: 8px;
      padding: 20px;
      font-size: 1em;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    dialog::backdrop { background: rgba(0,0,0,0.4); }
  </style>
</head>
<body>
  <h1>Diary</h1>
  <br />

  <!-- Insights area (centered) -->
  <div id="insights" style="margin: 40px auto; text-align: center; max-width: 600px;"></div>

  <!-- Form -->
  <label for="date">Date:</label>
  <input type="date" id="date" />

  <label for="mood">Today's feeling:</label>
  <select id="mood">
    <option value="">--How are you today?--</option>
    <optgroup label="🌞 Positive">
      <option value="happy">Happy</option>
      <option value="excited">Excited</option>
      <option value="motivated">Motivated</option>
      <option value="thankful">Thankful</option>
      <option value="peaceful">Peaceful</option>
      <option value="relaxed">Relaxed</option>
      <option value="confident">Confident</option>
    </optgroup>
    <optgroup label="🌧 Negative">
      <option value="sad">Sad</option>
      <option value="anxious">Anxious</option>
      <option value="tired">Tired</option>
      <option value="angry">Angry</option>
      <option value="lonely">Lonely</option>
      <option value="stressed">Stressed</option>
      <option value="frustrated">Frustrated</option>
    </optgroup>
    <optgroup label="😐 Neutral / Mixed">
      <option value="bored">Bored</option>
      <option value="neutral">Neutral</option>
      <option value="overwhelmed">Overwhelmed</option>
      <option value="curious">Curious</option>
      <option value="confused">Confused</option>
    </optgroup>
  </select>

  <label for="reason">What caused this feeling?</label>
  <select id="reason">
    <option value="">--What caused it?--</option>
    <optgroup label="🧠 Internal">
      <option value="personal_thoughts">Personal thoughts</option>
      <option value="self_doubt">Self-doubt</option>
      <option value="overthinking">Overthinking</option>
      <option value="expectations">Expectations</option>
      <option value="lack_of_sleep">Lack of sleep</option>
      <option value="physical_health">Physical health</option>
    </optgroup>
    <optgroup label="🌐 External">
      <option value="work">Work</option>
      <option value="family">Family</option>
      <option value="relationship">Relationship</option>
      <option value="friends">Friends</option>
      <option value="social_media">Social media</option>
      <option value="school">School / Study</option>
      <option value="finances">Finances</option>
      <option value="weather">Weather</option>
    </optgroup>
    <optgroup label="⚙️ Situational / Other">
      <option value="no_reason">No specific reason</option>
      <option value="routine">Daily routine</option>
      <option value="unexpected_event">Unexpected event</option>
      <option value="accomplishment">Accomplishment</option>
      <option value="conflict">Conflict</option>
      <option value="boredom">Boredom</option>
    </optgroup>
  </select>

  <label for="improvement">What did you do to feel better?</label>
  <select id="improvement">
    <option value="">--What helped?--</option>
    <optgroup label="💪 Physical">
      <option value="exercise">Exercise</option>
      <option value="walk">Walk</option>
      <option value="rest">Rest</option>
      <option value="sleep">Sleep</option>
      <option value="stretch">Stretch</option>
      <option value="shower">Take a shower</option>
    </optgroup>
    <optgroup label="🧠 Mental / Emotional">
      <option value="meditate">Meditate</option>
      <option value="journal">Journal</option>
      <option value="gratitude">Practice gratitude</option>
      <option value="breathing">Deep breathing</option>
      <option value="affirmations">Say affirmations</option>
    </optgroup>
    <optgroup label="🎨 Creative / Relaxing">
      <option value="music">Listen to music</option>
      <option value="art">Draw / Paint</option>
      <option value="read">Read</option>
      <option value="movie">Watch a movie</option>
      <option value="game">Play a game</option>
    </optgroup>
    <optgroup label="🧑‍🤝‍🧑 Social">
      <option value="friend">Talk to a friend</option>
      <option value="family">Spend time with family</option>
      <option value="vent">Vent to someone</option>
      <option value="disconnect">Avoid social media</option>
      <option value="help">Help someone else</option>
    </optgroup>
  </select>

  <label for="diaryText">Diary (Markdown supported):</label>
  <textarea id="diaryText" rows="10" placeholder="# Write your thoughts here using Markdown..."></textarea>

  <!-- Message dialog (OK only) -->
  <dialog id="messageDialog" aria-labelledby="messageText">
    <p id="messageText"></p>
    <button type="button" onclick="document.getElementById('messageDialog').close()">OK</button>
  </dialog>

  <!-- Confirm dialog (Yes/No) -->
  <dialog id="confirmDialog" aria-labelledby="confirmMessage">
    <p id="confirmMessage">Do you want to save?</p>
    <!-- ★ type="button" を付けて予期しないsubmitを回避 -->
    <button type="button" id="confirmYes">Yes</button>
    <button type="button" id="confirmNo">Cancel</button>
  </dialog>

  <div style="margin-top: 10px;">
    <button type="button" onclick="saveDiary()">Save</button>
    <button type="button" onclick="copyAllDiaries()">📋 Copy All Diaries</button>
    <button id="toggleAllButton" onclick="toggleViewAll(this)">🗂 View All</button>
  </div>

  <div id="allDiaries"></div>

  <h3>📄 Preview</h3>
  <div id="preview"></div>

  <script>
    // ---------- Preview ----------
    const diaryText = document.getElementById("diaryText");
    diaryText.addEventListener("input", updatePreview);
    function updatePreview() {
      const rawText = diaryText.value;
      const html = marked.parse(rawText);
      document.getElementById("preview").innerHTML = html;
    }

    // ---------- Dialog ----------
    function showDialog(message) {
      const dialog = document.getElementById('messageDialog');
      const messageText = document.getElementById('messageText');
      messageText.textContent = message;
      dialog.showModal();
    }

    // ★ confirm を Promise でラップ。Esc/クリック閉じでも false を返す
    // 非同期にする理由はユーザ側でyes/noを判断する時に「停止」の時間が生まれるから。
    function confirmDialog(message) {
      return new Promise((resolve) => {
        const dialog = document.getElementById("confirmDialog");
        const messageText = document.getElementById("confirmMessage");
        const yesButton = document.getElementById("confirmYes");
        const noButton = document.getElementById("confirmNo");

        messageText.textContent = message;
        dialog.showModal();

        const cleanup = () => {
          dialog.removeEventListener("close", onClose);
          yesButton.removeEventListener("click", onYes);
          noButton.removeEventListener("click", onNo);
        };

        const onYes = () => { dialog.returnValue = "yes"; dialog.close(); };
        const onNo  = () => { dialog.returnValue = "no";  dialog.close(); };

        const onClose = () => {
          const ok = dialog.returnValue === "yes";
          cleanup();
          resolve(ok);
        };

        // ★ once: true ではなく、close 時にまとめて外す方式
        yesButton.addEventListener("click", onYes);
        noButton.addEventListener("click", onNo);
        dialog.addEventListener("close", onClose);

        // ★ Esc キャンセルも close が走る（returnValue は "" → false）
      });
    }

    // ---------- Save ----------
    async function saveDiary() {
      const dateInput = document.getElementById('date');
      const moodSelect = document.getElementById('mood');
      const reasonSelect = document.getElementById('reason');
      const improvementSelect = document.getElementById('improvement');

      const date = dateInput.value;
      const mood = moodSelect.value;
      const reason = reasonSelect.value;
      const improvement = improvementSelect.value;
      const text = document.getElementById('diaryText').value;

      // Reset errors
      [dateInput, moodSelect, reasonSelect, improvementSelect].forEach(el => el.classList.remove("error"));

      let hasError = false;
      if (!date)        { dateInput.classList.add("error"); hasError = true; }
      if (!mood)        { moodSelect.classList.add("error"); hasError = true; }
      if (!reason)      { reasonSelect.classList.add("error"); hasError = true; }
      if (!improvement) { improvementSelect.classList.add("error"); hasError = true; }

      if (hasError) {
        showDialog("Please complete all required fields: date, mood, reason, and improvement.");
        return;
      }

      const key = "diary_" + date;
      const existing = localStorage.getItem(key);
      if (existing) {
        const confirmed = await confirmDialog("This date already has an entry. Overwrite?");
        if (!confirmed) return;
      }

      const diaryData = { text, mood, reason, improvement };
      localStorage.setItem(key, JSON.stringify(diaryData));
      showDialog("Saved successfully.");

      analyzeDiaryStats();
      // ★ 必要ならここで loadAllDiaries() を呼んで一覧を即更新
      loadAllDiaries();
    }

    // ---------- View All ----------
    function loadAllDiaries() {
      const container = document.getElementById("allDiaries");
      container.innerHTML = "";

      const entries = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith("diary_")) {
          const date = key.replace("diary_", "");
          const diaryData = JSON.parse(localStorage.getItem(key));
          entries.push({ date, ...diaryData });
        }
      }

      entries.sort((a, b) => b.date.localeCompare(a.date));

      if (entries.length === 0) {
        container.innerHTML = "<p>No diary entries found.</p>";
        return;
      }

      for (const entry of entries) {
        const section = document.createElement("section");
        section.style.backgroundColor = "black";
        section.style.color = "white";
        section.innerHTML = `
          <h3>📅 ${entry.date} (Feeling: ${entry.mood || "N/A"})</h3>
          <p><strong>Reason:</strong> ${entry.reason || "N/A"}</p>
          <p><strong>Improvement:</strong> ${entry.improvement || "N/A"}</p>
          <div>${marked.parse(entry.text || "")}</div>
        `;
        container.appendChild(section);
      }

      analyzeDiaryStats();
    }
    //ViewAll()ボタンのDiary全体表示/非表示に設定
    function toggleViewAll(btn) {
  const container = document.getElementById("allDiaries");
  const isOpen = container.dataset.open === "true";

  if (isOpen) {
    // 閉じる：中身を消してフラグ更新
    container.innerHTML = "";
    container.dataset.open = "false";
    btn.textContent = "🗂 View All";
  } else {
    // 開く：既存の描画関数を利用
    loadAllDiaries();
    container.dataset.open = "true";
    btn.textContent = "🙈 Hide";
  }
}

    // ---------- Copy All ----------
    function copyAllDiaries() {
      const entries = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith("diary_")) {
          const date = key.replace("diary_", "");
          const entry = JSON.parse(localStorage.getItem(key));
          entries.push({ date, ...entry });
        }
      }

      if (entries.length === 0) {
        showDialog("No diary entries to copy.");
        return;
      }

      entries.sort((a, b) => b.date.localeCompare(a.date));

      const fullText = entries.map(entry => 
`📅 Date: ${entry.date}
🌤 Mood: ${entry.mood || 'N/A'}
📌 Reason: ${entry.reason || 'N/A'}
🛠 Improvement: ${entry.improvement || 'N/A'}

📝 Diary:
${entry.text || '(No content)'}
------------------------------------------------------------`
      ).join("\n");

      // ★ HTTPS でのみ動作。ローカル file:// は失敗することあり
      navigator.clipboard.writeText(fullText)
        .then(() => showDialog("All diary entries copied!"))
        .catch(() => showDialog("Copy failed."));
    }

    // ---------- Analytics ----------
    function analyzeDiaryStats() {
      const moods = [];
      const actions = [];
      const dateSet = new Set();

      const POSITIVE = ['happy', 'joyful', 'excited', 'thankful', 'peaceful', 'relaxed', 'confident', 'motivated'];
      const NEUTRAL  = ['calm', 'okay', 'neutral', 'fine', 'normal'];
      const NEGATIVE = ['sad', 'tired', 'angry', 'frustrated', 'anxious', 'lonely', 'stressed'];

      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith("diary_")) {
          const date = key.replace("diary_", "");
          const entry = JSON.parse(localStorage.getItem(key));
          if (entry?.mood) moods.push({ date, mood: entry.mood });
          if (entry?.improvement) actions.push(entry.improvement);
          dateSet.add(date);
        }
      }

      if (moods.length === 0) {
        document.getElementById("insights").innerHTML = "<p>No analysis available yet.</p>";
        return;
      }

      const dateList = Array.from(dateSet).sort();
      const consecutiveDays = countConsecutiveDatesUTC(dateList); // ★ UTC安定版へ
      const streaks = countMoodStreakExtended(moods, POSITIVE, NEUTRAL, NEGATIVE);
      const topMoods = getTopCommon(moods.map(m => m.mood), 5);
      const topActions = getTopCommon(actions, 10);

      document.getElementById("insights").innerHTML = `
        <h3>📊 Insights</h3>
        <p>📅 Written <strong>${consecutiveDays}</strong> days in a row.</p>
        <p>🌞 Positive streak: <strong>${streaks.positive}</strong> days</p>
        <p>😐 Neutral streak: <strong>${streaks.neutral}</strong> days</p>
        <p>🌧 Negative streak: <strong>${streaks.negative}</strong> days</p>
        <p>💬 Top 5 moods:</p>
        <ul>${topMoods.map(m => `<li>${m.key} (${m.count})</li>`).join("")}</ul>
        <p>🎯 Top helpful actions:</p>
        <ul>${topActions.map(a => `<li>${a.key} (${a.count})</li>`).join("")}</ul>
      `;
    }

    // ★ タイムゾーン影響を避けるため UTC で連続日数を判定
    function countConsecutiveDatesUTC(dateStrings) {
      // dateStrings: ["2025-08-01","2025-08-02", ...] (昇順)
      if (dateStrings.length === 0) return 0;
      let count = 1;
      for (let i = dateStrings.length - 1; i > 0; i--) {
        const d1 = toUTCDate(dateStrings[i]);
        const d0 = toUTCDate(dateStrings[i - 1]);
        const diffDays = Math.round((d1 - d0) / 86400000); // 1000*60*60*24
        if (diffDays === 1) count++;
        else break;
      }
      return count;
    }
    function toUTCDate(yyyy_mm_dd) {
      const [y, m, d] = yyyy_mm_dd.split("-").map(Number);
      return new Date(Date.UTC(y, m - 1, d)); // ★ 必ずUTC 00:00を生成
    }

    function countMoodStreakExtended(entries, POSITIVE, NEUTRAL, NEGATIVE) {
      const sorted = entries.slice().sort((a, b) => b.date.localeCompare(a.date));
      let pos = 0, neu = 0, neg = 0;

      for (const entry of sorted) {
        if (POSITIVE.includes(entry.mood)) pos++;
        else break;
      }
      for (const entry of sorted) {
        if (NEUTRAL.includes(entry.mood)) neu++;
        else break;
      }
      for (const entry of sorted) {
        if (NEGATIVE.includes(entry.mood)) neg++;
        else break;
      }
      return { positive: pos, neutral: neu, negative: neg };
    }

    function getTopCommon(arr, topN = 5) {
      const freq = {};
      for (const item of arr) {
        if (!item) continue;
        freq[item] = (freq[item] || 0) + 1;
      }
      return Object.entries(freq)
        .map(([key, count]) => ({ key, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, topN);
    }
  </script>
</body>
</html>>
